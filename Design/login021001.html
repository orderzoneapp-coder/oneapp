<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>오더즈 - 식자재 주문의 새로운 기준</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
        :root { 
            --brand-primary: #14682A; 
            --brand-hover: #0f5220; 
            --box-bg: #f8fafc; 
            --required-color: #f472b6;
        }
        /* [Layout] h-screen과 flex로 전체 화면 꽉 채움 */
        .check-container { 
            max-width: 480px; margin: 0 auto; background-color: #ffffff; 
            height: 100vh; /* min-height 대신 height로 고정하여 flex 비율 유지 */
            display: flex; flex-direction: column;
            padding: 0 24px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; 
            overflow-y: auto; /* 내용 넘칠 때만 스크롤 */
        }
        
        /* Checkbox & Inputs */
        .checkbox-wrapper input:checked + div { background-color: var(--brand-primary); border-color: var(--brand-primary); }
        .checkbox-wrapper input:checked + div svg { display: block; }
        .input-focus:focus { outline: none; border-color: var(--brand-primary); box-shadow: 0 0 0 1px var(--brand-primary); background-color: #fff; }
        .input-box-style { background-color: var(--box-bg); }
        .placeholder-required::placeholder { color: #9ca3af; font-weight: 400; }

        /* Buttons */
        .btn-kakao { background-color: #FEE500; color: #191919; }
        .btn-brand { background-color: var(--brand-primary); color: white; }
        .btn-brand:hover { background-color: var(--brand-hover); }
        .btn-connect { background-color: #55b068; color: white; }
        .btn-connect:hover { background-color: #449d56; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none; }
        
        /* Modals */
        #toast-overlay, #kakao-sync-modal, #sim-settings-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 5000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #toast-overlay.show, #kakao-sync-modal.show, #sim-settings-modal.show { opacity: 1; pointer-events: all; }
        
        .modal-window { width: 90%; max-width: 360px; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .kakao-window { width: 100%; max-width: 360px; background: #fff; height: auto; border-radius: 8px; overflow: hidden; }

        /* Step Indicator */
        .step-dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background-color: #e5e7eb; transition: background-color 0.3s; }
        .dot.active { background-color: var(--brand-primary); }

        /* Form Labels */
        .form-section-title { font-size: 14px; font-weight: bold; color: #1f2937; margin-bottom: 8px; border-bottom: 1px solid #e5e7eb; padding-bottom: 4px; margin-top: 20px; }
        .form-label { display: block; font-size: 12px; font-weight: bold; color: #4b5563; margin-bottom: 4px; }
        .required-mark { color: var(--required-color); font-size: 11px; margin-left: 2px; }

        /* Sim Settings Modal Specifics */
        .sim-option {
            border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .sim-option:hover { background-color: #f8fafc; }
        .sim-option.selected { border-color: #3b82f6; background-color: #eff6ff; color: #1d4ed8; font-weight: bold; }
        .sim-check { width: 16px; height: 16px; border: 1px solid #cbd5e1; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .sim-option.selected .sim-check { border-color: #3b82f6; background-color: #3b82f6; }
        .sim-option.selected .sim-check::after { content: ''; width: 6px; height: 6px; background: white; border-radius: 50%; display: block; }
    </style>
</head>
<body>

    <div class="check-container relative">
        
        <!-- [상단] Header (고정 영역) -->
        <div class="flex justify-between items-center pt-8 pb-4 shrink-0">
            <div class="w-8"></div>
            <h1 class="text-3xl font-black text-[#14682A] tracking-tight cursor-pointer" onclick="location.reload()">ORDERZ</h1>
            <button onclick="openSimSettings()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600">
                <i class="fas fa-cog"></i>
            </button>
        </div>

        <div class="step-dots hidden shrink-0" id="step-indicator">
            <div id="dot1" class="dot active"></div>
            <div id="dot2" class="dot"></div>
        </div>

        <!-- Form Wrapper: 남은 공간 모두 차지 -->
        <form id="joinForm" onsubmit="return false;" class="flex-1 flex flex-col">
            <input type="hidden" name="yt_code" id="yt_code"> 
            <input type="hidden" name="join_source" id="join_source">
            <input type="hidden" name="next_url" id="next_url">
            <input type="hidden" name="join_type" id="join_type" value="general">

            <!-- ================= STEP 1: 통합 게이트웨이 ================= -->
            <div id="step1_section" class="fade-in flex flex-col flex-1 h-full">
                
                <!-- [중앙] 메인 컨텐츠 영역 (핵심: justify-center로 수직 중앙 정렬) -->
                <div class="flex-1 flex flex-col justify-center w-full">
                    
                    <!-- 슬로건 영역 -->
                    <div class="text-center mb-10" id="intro-text">
                        <h2 class="text-xl font-bold text-gray-800 mb-2">오더즈가 기억합니다</h2>
                        <p class="text-sm font-medium text-[#14682A]">
                            내 방식대로, 쓸수록 손에 익는 플랫폼
                        </p>
                    </div>

                    <!-- [기존 아이디 로그인 폼] (평소엔 숨김) -->
                    <div id="loginFormArea" class="hidden fade-in mb-8">
                        <div class="text-center mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-1">기존 계정에 연결하기</h3>
                        </div>
                        <div class="bg-[#e9f7ef] border border-[#d0e9d4] rounded-md p-4 mb-6 text-center">
                            <p class="text-xs text-[#2c5f36] leading-relaxed break-keep">
                                기존 아이디에 <span class="font-bold">SNS 아이디를 연결</span>합니다.<br>
                                이 후 SNS 아이디로 로그인 하시면 기존 아이디로<br>
                                로그인 할 수 있습니다.
                            </p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-1.5">아이디 <span class="text-gray-400 text-xs font-normal ml-0.5">(필수)</span></label>
                            <input type="text" name="login_id" id="login_id" value="test_owner"
                                class="w-full px-4 py-3.5 border border-gray-200 rounded-lg input-box-style input-focus transition-colors text-sm placeholder-required"
                                placeholder="아이디를 입력하세요">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-gray-700 mb-1.5">비밀번호 <span class="text-gray-400 text-xs font-normal ml-0.5">(필수)</span></label>
                            <input type="password" name="login_pw" id="login_pw" value="1234"
                                class="w-full px-4 py-3.5 border border-gray-200 rounded-lg input-box-style input-focus transition-colors text-sm"
                                placeholder="비밀번호를 입력하세요">
                        </div>
                        <button type="button" onclick="processConnectLogin()"
                            class="w-full py-4 btn-connect rounded-lg font-bold text-[15px] shadow-md transition">
                            연결하기
                        </button>
                        <div class="mt-4 text-center">
                            <button onclick="processJustLogin()" class="text-xs text-gray-400 underline hover:text-gray-600">
                                연결 없이 로그인
                            </button>
                        </div>
                    </div>

                    <!-- [메인 버튼 그룹] -->
                    <div class="flex flex-col gap-3" id="mainBtnGroup">
                        <!-- 카카오 (Main) -->
                        <button type="button" id="btnKakao" onclick="processKakaoGateway()"
                            class="w-full py-4 rounded-lg font-bold text-[15px] btn-kakao flex items-center justify-center gap-2 shadow-sm hover:opacity-90 transition transform active:scale-[0.98]">
                            <i class="fas fa-comment text-lg"></i>
                            시작하기
                        </button>
                    </div>
                </div>

                <!-- [하단] 선택지 영역 (고정) -->
                <!-- mt-8로 위 요소와 간격 확보, pb-10으로 하단 여백 확보 -->
                <div class="shrink-0 pb-10 mt-8 text-center flex justify-center gap-4 text-xs text-gray-500" id="loginLinkArea">
                    <button type="button" onclick="showLoginForm()" class="hover:text-[#14682A] transition-colors underline decoration-gray-300">
                        일반로그인
                    </button>
                    <span class="text-gray-300">|</span>
                    <button type="button" onclick="showSignupForm()" class="hover:text-[#14682A] transition-colors underline decoration-gray-300">
                        회원가입
                    </button>
                </div>
                
                <!-- 초기화면 복귀 링크 -->
                <div class="shrink-0 pb-10 mt-8 text-center hidden" id="backLinkArea">
                    <button type="button" onclick="resetToMain()" class="text-xs text-gray-400 font-normal hover:text-gray-600 transition-colors">
                        <span class="border-b border-gray-300 pb-0.5">초기 화면으로 돌아가기</span>
                    </button>
                </div>

            </div>

            <!-- ================= 회원가입 폼 (New) ================= -->
            <div id="signupFormArea" class="hidden fade-in flex flex-col h-full pb-10 overflow-y-auto">
                <div class="text-center mb-6 mt-4">
                    <h2 class="text-xl font-bold text-gray-800">회원 가입</h2>
                </div>

                <!-- Section 1: 사이트 이용정보 -->
                <h4 class="form-section-title">사이트 이용정보 입력</h4>
                <div class="mb-4">
                    <label class="form-label">아이디 <span class="required-mark">*</span></label>
                    <input type="text" class="w-full px-3 py-2 border border-gray-200 rounded input-box-style text-sm input-focus" placeholder="영문자, 숫자, _ 만 입력 가능">
                </div>
                <div class="mb-4">
                    <label class="form-label">비밀번호 <span class="required-mark">*</span></label>
                    <input type="password" class="w-full px-3 py-2 border border-gray-200 rounded input-box-style text-sm input-focus">
                </div>
                <div class="mb-4">
                    <label class="form-label">비밀번호 확인 <span class="required-mark">*</span></label>
                    <input type="password" class="w-full px-3 py-2 border border-gray-200 rounded input-box-style text-sm input-focus">
                </div>

                <!-- Section 2: 상호정보 -->
                <h4 class="form-section-title">상호(업체)정보 입력</h4>
                <div class="mb-4">
                    <label class="form-label">업체명 <span class="required-mark">*</span></label>
                    <input type="text" class="w-full px-3 py-2 border border-gray-200 rounded input-box-style text-sm input-focus">
                </div>
                <div class="mb-4">
                    <label class="form-label">대표자명</label>
                    <input type="text" class="w-full px-3 py-2 border border-gray-200 rounded input-box-style text-sm input-focus">
                </div>
                <div class="mb-4">
                    <label class="form-label">휴대폰번호 <span class="required-mark">*</span></label>
                    <input type="tel" class="w-full px-3 py-2 border border-gray-200 rounded input-box-style text-sm input-focus" oninput="autoHyphen(this)">
                </div>

                <!-- Section 3: 주소 -->
                <h4 class="form-section-title">배송지 정보 <span class="text-xs text-gray-400 font-normal ml-1">(직배송 상품 노출용)</span></h4>
                <div class="flex gap-2 mb-2">
                    <input type="text" id="signup_zip" class="w-24 px-3 py-2 border border-gray-200 rounded input-box-style text-sm input-focus" placeholder="우편번호" readonly>
                    <button type="button" onclick="openSignupPostcode()" class="px-3 py-2 bg-white border border-gray-300 rounded text-xs font-bold text-gray-600">주소검색</button>
                </div>
                <div class="mb-2">
                    <input type="text" id="signup_addr1" class="w-full px-3 py-2 border border-gray-200 rounded input-box-style text-sm input-focus" placeholder="기본 주소" readonly>
                </div>
                <div class="mb-4">
                    <input type="text" id="signup_addr2" class="w-full px-3 py-2 border border-gray-200 rounded input-box-style text-sm input-focus" placeholder="상세 주소">
                </div>

                <!-- Section 4: 사업자번호 -->
                <h4 class="form-section-title">사업자 정보</h4>
                <div class="flex gap-2 mb-8">
                    <input type="tel" class="flex-1 px-3 py-2 border border-gray-200 rounded input-box-style text-sm input-focus" placeholder="사업자등록번호 (숫자만)" maxlength="10">
                    <button type="button" class="px-3 py-2 bg-white border border-gray-300 rounded text-xs font-bold text-gray-600 whitespace-nowrap">중복확인</button>
                </div>

                <button type="button" onclick="processSignup()" class="w-full py-4 btn-brand rounded-lg font-bold text-[15px] shadow-md transition hover:bg-[#0f5220] mb-4">
                    회원가입 완료
                </button>
                 <div class="text-center pb-8">
                    <button type="button" onclick="resetToMain()" class="text-xs text-gray-400 font-normal hover:text-gray-600 transition-colors border-b border-gray-300 pb-0.5">
                        취소하고 돌아가기
                    </button>
                </div>
            </div>

            <!-- ================= STEP 2: 마케팅 간편 정보 입력 (기존 로직 유지) ================= -->
            <div id="step2_section" class="hidden flex flex-col h-full">
                <!-- 마케팅 유입 시 Step 2도 중앙 정렬 -->
                <div class="flex-1 flex flex-col justify-center">
                    <div class="mb-10 text-center">
                        <h2 class="text-xl font-bold text-gray-800 mb-2">주소 기반 상품 매칭</h2>
                        <p class="text-sm font-medium text-[#14682A] break-keep">
                            사장님 지역의 특가 상품을 지금 확인해보세요.
                        </p>
                    </div>

                    <div class="mb-5">
                        <label class="block text-sm font-bold text-gray-700 mb-1.5">
                            상호명 <span class="text-pink-400 text-xs font-normal ml-0.5">(필수)</span>
                        </label>
                        <input type="text" name="mb_company" id="mb_company" 
                            class="w-full px-4 py-3.5 border border-gray-200 rounded-lg input-box-style input-focus transition-colors text-sm placeholder-required"
                            placeholder="상호명을 입력하세요" onkeydown="handleCompanyKeydown(event)">
                    </div>

                    <div class="mb-8">
                        <label class="block text-sm font-bold text-gray-700 mb-1.5">
                            가게 주소 (배송지) <span class="text-pink-400 text-xs font-normal ml-0.5">(필수)</span>
                        </label>
                        <div class="flex gap-2 mb-2">
                            <input type="hidden" name="mb_zip" id="mb_zip">
                            <input type="hidden" name="mb_addr3" id="mb_addr3">
                            <input type="text" name="mb_addr1" id="mb_addr1" 
                                class="flex-1 px-4 py-3.5 border border-gray-200 rounded-lg input-box-style text-gray-800 text-sm input-focus cursor-pointer placeholder-required"
                                placeholder="우측 버튼으로 검색하세요" readonly onclick="openDaumPostcode()">
                            <button type="button" onclick="openDaumPostcode()" 
                                class="px-5 py-3.5 btn-brand text-sm font-bold rounded-lg transition whitespace-nowrap shadow-sm">
                                검색
                            </button>
                        </div>
                        <input type="text" name="mb_addr2" id="mb_addr2" 
                            class="w-full px-4 py-3.5 border border-gray-200 rounded-lg input-box-style input-focus text-sm transition-colors"
                            placeholder="상세주소를 입력해주세요 (예: 1층)" >
                    </div>
                </div>

                <div class="shrink-0 pb-10">
                    <button type="button" onclick="submitFinalForm()"
                        class="w-full py-4 btn-brand rounded-lg font-bold text-[15px] shadow-md transition hover:bg-[#0f5220] mb-4">
                        완료
                    </button>
                    <div class="text-center">
                        <button type="button" onclick="resetToMain()" class="text-xs text-gray-400 font-normal hover:text-gray-600 transition-colors">
                            <span class="border-b border-gray-300 pb-0.5">이전으로</span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- [Simulation Settings Modal] -->
    <div id="sim-settings-modal">
        <div class="modal-window p-5">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="font-bold text-gray-800"><i class="fas fa-tools mr-2 text-gray-400"></i>시뮬레이션 환경 설정</h3>
                <button onclick="closeSimSettings()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="mb-4">
                <p class="text-xs font-bold text-gray-500 mb-2">1. 대상 회원 상태</p>
                <div class="sim-option selected" id="opt-user-new" onclick="setSimState('user', 'NEW')">
                    <span class="text-sm">신규 회원 (가입 미완료)</span>
                    <div class="sim-check"></div>
                </div>
                <div class="sim-option" id="opt-user-exist" onclick="setSimState('user', 'EXISTING')">
                    <span class="text-sm">기존 회원 (가입 완료)</span>
                    <div class="sim-check"></div>
                </div>
            </div>

            <div class="mb-5">
                <p class="text-xs font-bold text-gray-500 mb-2">2. 유입 경로 (Context)</p>
                <div class="sim-option selected" id="opt-flow-mkt" onclick="setSimState('flow', 'MARKETING')">
                    <span class="text-sm">마케팅 링크 유입 (yt_code 있음)</span>
                    <div class="sim-check"></div>
                </div>
                <div class="sim-option" id="opt-flow-org" onclick="setSimState('flow', 'ORGANIC')">
                    <span class="text-sm">일반/자연 유입 (yt_code 없음)</span>
                    <div class="sim-check"></div>
                </div>
            </div>

            <button onclick="applySimSettings()" class="w-full bg-[#14682A] text-white py-3 rounded-lg font-bold text-sm shadow hover:bg-[#0f5220]">
                설정 적용 및 새로고침
            </button>
        </div>
    </div>

    <!-- [카카오싱크 가상 창] -->
    <div id="kakao-sync-modal">
        <div class="kakao-window shadow-2xl p-6 bg-white">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center">
                    <i class="fas fa-comment text-[#3c1e1e] text-lg mr-2"></i>
                    <span class="font-bold text-sm text-[#3c1e1e]">Kakao</span>
                </div>
                <button onclick="closeKakaoSync()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gray-100 rounded-full mx-auto mb-3 flex items-center justify-center">
                    <span class="font-black text-[#14682A]">ORDERZ</span>
                </div>
                <h3 class="font-bold text-lg text-gray-800 mb-1">오더즈</h3>
                <p class="text-xs text-gray-500">서비스 이용을 위해 정보 제공에 동의해주세요.</p>
            </div>
            <div class="border-t border-gray-100 pt-4 space-y-3 text-sm text-left">
                <div class="flex items-start"><i class="fas fa-check-circle text-[#FEE500] mt-0.5 mr-2"></i><div><span class="text-gray-500">[필수]</span> 프로필 정보</div></div>
                <div class="flex items-start"><i class="fas fa-check-circle text-[#FEE500] mt-0.5 mr-2"></i><div><span class="text-gray-500">[필수]</span> 카카오계정(전화번호)</div></div>
                <div class="flex items-start"><i class="fas fa-check-circle text-[#FEE500] mt-0.5 mr-2"></i><div><span class="text-gray-500">[필수]</span> 서비스 이용약관</div></div>
            </div>
            <div class="mt-6">
                <button onclick="confirmKakaoSync()" class="w-full bg-[#FEE500] text-[#191919] py-3.5 rounded font-bold hover:bg-[#fdd835] transition text-sm">동의하고 계속하기</button>
            </div>
        </div>
    </div>

    <!-- [성공 팝업 - 이미지 반영] -->
    <div id="toast-overlay">
        <div class="bg-white rounded-xl p-6 w-[320px] text-center shadow-2xl transform scale-100 transition-transform relative">
            <div id="popup-linked" class="hidden">
                <div class="w-12 h-12 bg-green-50 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fas fa-check"></i></div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">카카오 로그인 연결 성공!</h3>
                <div class="text-sm text-gray-600 mb-5 leading-relaxed break-keep">이제 카카오 계정으로<br>더 빠르게 로그인할 수 있습니다.</div>
                <div class="bg-gray-50 rounded-lg p-3 text-left border border-gray-100 mb-5">
                    <p class="text-[11px] text-gray-500 mb-1 leading-snug">연결된 계정 관리는 <strong>마이페이지</strong>에서 확인 가능합니다.</p>
                    <p class="text-[11px] text-gray-500 leading-snug">보안상 계정 해제가 필요할 경우 <strong>고객센터</strong>로 문의해주세요.</p>
                </div>
            </div>
            <div id="popup-normal" class="hidden">
                 <div class="w-12 h-12 bg-green-50 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fas fa-check"></i></div>
                <h3 class="text-lg font-bold text-gray-800 mb-2" id="normal-title">완료되었습니다!</h3>
                <div class="text-sm text-gray-600 mb-5 leading-relaxed break-keep" id="normal-desc">페이지로 이동합니다.</div>
            </div>
            <div id="toast-loading" class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden mb-2">
                <div class="bg-green-500 h-full w-0 transition-all duration-[1500ms] ease-out" id="progress-bar"></div>
            </div>
            <div id="toast-btn-area" class="hidden mt-4">
                 <button onclick="goToNextPage()" class="w-full bg-[#14682A] text-white py-3 rounded-lg font-bold text-sm hover:bg-[#0f5220] transition shadow-md">확인 (이동하기)</button>
            </div>
        </div>
    </div>

    <script>
        let simConfig = { userType: 'NEW', flowType: 'ORGANIC' };

        window.addEventListener('DOMContentLoaded', () => { initPage(); });

        function initPage() {
            if (simConfig.flowType === 'MARKETING') {
                document.getElementById('yt_code').value = 'TEST_CODE';
                document.querySelector('#intro-text h2').innerText = "우리 가게 식자재, 더 싸고 편리하게";
                document.querySelector('#intro-text p').innerHTML = "사장님! 우리동네 특가 상품을<br>지금 확인해보세요.";
                document.getElementById('step-indicator').classList.remove('hidden');
            } else {
                document.getElementById('yt_code').value = '';
                document.querySelector('#intro-text h2').innerText = "오더즈가 기억합니다";
                document.querySelector('#intro-text p').innerText = "내 방식대로, 쓸수록 손에 익는 플랫폼";
                document.getElementById('step-indicator').classList.add('hidden');
            }
            const urlParams = new URLSearchParams(window.location.search);
            document.getElementById('next_url').value = urlParams.get('next_url') || 'https://orderz.kr/shop/';
        }

        // --- Settings ---
        function openSimSettings() { updateSimUI('user', simConfig.userType); updateSimUI('flow', simConfig.flowType); document.getElementById('sim-settings-modal').classList.add('show'); }
        function closeSimSettings() { document.getElementById('sim-settings-modal').classList.remove('show'); }
        function setSimState(group, value) { if(group==='user') simConfig.userType=value; if(group==='flow') simConfig.flowType=value; updateSimUI(group, value); }
        function updateSimUI(group, value) {
            const opts = group==='user'?['new','exist']:['mkt','org'];
            const valMap = group==='user'?{new:'NEW',exist:'EXISTING'}:{mkt:'MARKETING',org:'ORGANIC'};
            opts.forEach(opt=>{
                const el=document.getElementById(`opt-${group}-${opt}`);
                if(valMap[opt]===value) el.classList.add('selected'); else el.classList.remove('selected');
            });
        }
        function applySimSettings() {
            closeSimSettings();
            document.getElementById('step1_section').classList.remove('hidden');
            document.getElementById('step1_section').classList.add('fade-in');
            document.getElementById('step2_section').classList.add('hidden');
            document.getElementById('step2_section').classList.remove('fade-in');
            document.getElementById('signupFormArea').classList.add('hidden'); // Reset signup
            
            const dot2 = document.getElementById('dot2'); if(dot2) dot2.classList.remove('active');
            initPage(); resetToMain();
            alert(`[설정 완료]\n회원: ${simConfig.userType}\n유입: ${simConfig.flowType}\n\n초기 화면으로 이동합니다.`);
        }

        // --- Auth ---
        function processKakaoGateway() {
            if (simConfig.userType === 'EXISTING') { completeLogin('EXISTING'); } 
            else { document.getElementById('kakao-sync-modal').classList.add('show'); }
        }
        function closeKakaoSync() { document.getElementById('kakao-sync-modal').classList.remove('show'); }
        function confirmKakaoSync() {
            closeKakaoSync();
            if (simConfig.userType === 'EXISTING') { completeLogin('EXISTING'); } 
            else { document.getElementById('join_type').value = 'kakao'; goToStep2(); }
        }

        // --- Navigation ---
        function showLoginForm() {
            document.getElementById('mainBtnGroup').classList.add('hidden');
            document.getElementById('loginLinkArea').classList.add('hidden');
            document.getElementById('loginFormArea').classList.remove('hidden');
            document.getElementById('backLinkArea').classList.remove('hidden');
            document.getElementById('login_id').focus();
        }
        function showSignupForm() {
            document.getElementById('step1_section').classList.add('hidden');
            document.getElementById('signupFormArea').classList.remove('hidden');
            document.getElementById('signupFormArea').classList.add('fade-in');
        }
        function resetToMain() {
            document.getElementById('step1_section').classList.remove('hidden');
            document.getElementById('step1_section').classList.add('fade-in');
            
            document.getElementById('loginFormArea').classList.add('hidden');
            document.getElementById('signupFormArea').classList.add('hidden');
            document.getElementById('step2_section').classList.add('hidden');
            
            document.getElementById('mainBtnGroup').classList.remove('hidden');
            document.getElementById('loginLinkArea').classList.remove('hidden');
            document.getElementById('backLinkArea').classList.add('hidden');
            
            // Clean up forms
            document.getElementById('loginFormArea').classList.remove('fade-in');
            document.getElementById('signupFormArea').classList.remove('fade-in');
        }

        // --- Actions ---
        function processConnectLogin() {
            const id = document.getElementById('login_id').value;
            const pw = document.getElementById('login_pw').value;
            if(!id || !pw) { alert('아이디와 비밀번호를 입력해주세요.'); return; }
            completeLogin('LINKED');
        }
        function processJustLogin() {
            const id = document.getElementById('login_id').value;
            const pw = document.getElementById('login_pw').value;
            if(!id || !pw) { alert('아이디와 비밀번호를 입력해주세요.'); return; }
            completeLogin('JUST_LOGIN');
        }

        function processSignup() {
            alert("[시뮬레이션] 회원가입 정보가 전송되었습니다.");
            completeLogin('NEW');
        }

        function goToStep2() {
            document.getElementById('step1_section').classList.add('hidden');
            const step2 = document.getElementById('step2_section');
            step2.classList.remove('hidden');
            step2.classList.add('fade-in');
            const dot2 = document.getElementById('dot2'); if(dot2) dot2.classList.add('active');
            setTimeout(() => { 
                const companyInput = document.getElementById('mb_company');
                companyInput.focus(); companyInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

        function submitFinalForm() {
            const company = document.getElementById('mb_company');
            const addr1 = document.getElementById('mb_addr1');
            if(!company.value) { alert("상호명을 입력해주세요."); company.focus(); return; }
            if(!addr1.value) { alert("주소를 검색해주세요."); openDaumPostcode(); return; }
            completeLogin('NEW');
        }

        function completeLogin(type) {
            const toast = document.getElementById('toast-overlay');
            const bar = document.getElementById('progress-bar');
            const popupLinked = document.getElementById('popup-linked');
            const popupNormal = document.getElementById('popup-normal');
            const normalTitle = document.getElementById('normal-title');
            const normalDesc = document.getElementById('normal-desc');
            const loadingArea = document.getElementById('toast-loading');
            const btnArea = document.getElementById('toast-btn-area');

            loadingArea.classList.remove('hidden');
            btnArea.classList.add('hidden');
            bar.style.width = '0%';
            popupLinked.classList.add('hidden');
            popupNormal.classList.add('hidden');

            if (type === 'LINKED') {
                popupLinked.classList.remove('hidden');
            } else {
                popupNormal.classList.remove('hidden');
                if (type === 'JUST_LOGIN') {
                     normalTitle.innerText = "로그인 성공";
                     normalDesc.innerHTML = `반갑습니다 사장님!<br>페이지로 이동합니다.`;
                } else if (type === 'EXISTING') {
                    normalTitle.innerText = "확인되었습니다.";
                    normalDesc.innerHTML = `반갑습니다 사장님!<br><span class="text-[#14682A] font-bold">요청하신 페이지로 이동합니다.</span>`;
                } else {
                    normalTitle.innerText = "완료되었습니다!";
                    normalDesc.innerHTML = `매칭 및 등록 완료.<br><span class="text-[#14682A] font-bold">상품 페이지로 이동합니다.</span>`;
                }
            }
            
            toast.classList.add('show');
            setTimeout(() => { bar.style.width = "100%"; }, 100);
            setTimeout(() => { loadingArea.classList.add('hidden'); btnArea.classList.remove('hidden'); }, 1600);
        }

        function goToNextPage() {
            const nextUrl = document.getElementById('next_url').value;
            alert(`[시스템 이동] ${nextUrl} 로 이동합니다.`);
            window.location.reload(); 
        }

        function handleCompanyKeydown(event) { if (event.key === 'Enter') { event.preventDefault(); const addrInput = document.getElementById('mb_addr1'); addrInput.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }
        
        function openDaumPostcode() {
            if (typeof daum === 'undefined') { alert("우편번호 서비스 로딩 중..."); return; }
            new daum.Postcode({
                oncomplete: function(data) {
                    var addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                    if(data.userSelectedType === 'J' && !addr){ addr = data.autoJibunAddress; }
                    var extraAddr = '';
                    if(data.userSelectedType === 'R'){ if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){ extraAddr += data.bname; } if(data.buildingName !== '' && data.apartment === 'Y'){ extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName); } if(extraAddr !== ''){ extraAddr = ' (' + extraAddr + ')'; } }
                    if(document.getElementById('mb_zip')) { document.getElementById('mb_zip').value = data.zonecode; }
                    const addrInput = document.getElementById('mb_addr1');
                    if(addrInput) { addrInput.value = addr; addrInput.classList.add('text-gray-900', 'font-medium'); }
                    if(document.getElementById('mb_addr3')) { document.getElementById('mb_addr3').value = extraAddr; }
                    if(document.getElementById('mb_addr2')) { document.getElementById('mb_addr2').focus(); }
                }
            }).open();
        }
        
        function openSignupPostcode() {
            if (typeof daum === 'undefined') { alert("우편번호 서비스 로딩 중..."); return; }
            new daum.Postcode({
                oncomplete: function(data) {
                    var addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                    if(document.getElementById('signup_zip')) document.getElementById('signup_zip').value = data.zonecode;
                    if(document.getElementById('signup_addr1')) document.getElementById('signup_addr1').value = addr;
                }
            }).open();
        }

        function autoHyphen(target) { target.value = target.value.replace(/[^0-9]/g, '').replace(/^(\d{0,3})(\d{0,4})(\d{0,4})$/g, "$1-$2-$3").replace(/(\-{1,2})$/g, ""); }
    </script>
</body>
</html>
