<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>오더즈 - 식자재 최저가 확인</title>
    
    <!-- 1. 필수 라이브러리 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- 2. Daum 우편번호 서비스 (HTTPS 필수) -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; }
        
        /* [Brand Color] */
        :root {
            --brand-primary: #14682A; /* 오더즈 그린 */
            --brand-hover: #0f5220;
            --box-bg: #f8fafc;
            --required-color: #f472b6; /* 필수값 강조 (분홍) */
        }

        .check-container {
            max-width: 480px; margin: 0 auto; background-color: #ffffff;
            min-height: 100vh; padding: 40px 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Checkbox Custom */
        .checkbox-wrapper input:checked + div {
            background-color: var(--brand-primary);
            border-color: var(--brand-primary);
        }
        .checkbox-wrapper input:checked + div svg { display: block; }
        
        /* Buttons */
        .btn-kakao { background-color: #FEE500; color: #191919; }
        .btn-brand { background-color: var(--brand-primary); color: white; }
        .btn-brand:hover { background-color: var(--brand-hover); }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none; }

        /* Toast Popup */
        #toast-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 50;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #toast-overlay.show { opacity: 1; pointer-events: all; }

        /* Input Styles */
        .input-focus:focus { outline: none; border-color: var(--brand-primary); box-shadow: 0 0 0 1px var(--brand-primary); background-color: #fff; }
        .input-box-style { background-color: var(--box-bg); }
        .placeholder-required::placeholder { color: #9ca3af; font-weight: 400; }
        
        /* Step Indicator */
        .step-dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background-color: #e5e7eb; transition: background-color 0.3s; }
        .dot.active { background-color: var(--brand-primary); }
    </style>
</head>
<body>

    <div class="check-container relative">
        
        <!-- Logo -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-black text-[#14682A] tracking-tight cursor-pointer" onclick="location.reload()">ORDERZ</h1>
        </div>

        <!-- Step Indicator -->
        <div class="step-dots">
            <div id="dot1" class="dot active"></div>
            <div id="dot2" class="dot"></div>
        </div>

        <!-- Form Start -->
        <form id="joinForm" onsubmit="return false;">
            
            <!-- Hidden Fields (마케팅 파라미터) -->
            <input type="hidden" name="yt_code" id="yt_code"> 
            <input type="hidden" name="join_source" id="join_source"> <!-- 본사/유통사 구분 -->
            <input type="hidden" name="next_url" id="next_url">
            <input type="hidden" name="join_type" id="join_type" value="general">

            <!-- ================= STEP 1: 고객 유입 (Lead Gen) ================= -->
            <div id="step1_section" class="fade-in">
                
                <div class="mb-8 text-center">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">식자재 특가 상품 보기</h2>
                    <p class="text-sm font-medium text-[#14682A]">
                        사장님 지역의 직배송 상품과 혜택을<br>지금 바로 확인해보세요.
                    </p>
                </div>

                <!-- [일반 가입] 휴대폰 번호 입력 -->
                <div id="generalInputArea" class="hidden fade-in mb-6">
                    <div class="mb-5">
                        <label class="block text-sm font-bold text-gray-700 mb-1.5">
                            휴대폰 번호 <span class="text-pink-400 text-xs font-normal ml-0.5">(필수)</span>
                        </label>
                        <input type="tel" name="mb_hp" id="mb_hp" maxlength="13"
                            class="w-full px-4 py-3.5 border border-gray-200 rounded-lg input-box-style input-focus transition-colors text-sm placeholder-required"
                            placeholder="010-0000-0000 (숫자만 입력)" oninput="autoHyphen(this)">
                    </div>

                    <!-- 약관 동의 -->
                    <div class="border border-gray-200 rounded-lg p-4 input-box-style hover:border-[#14682A] transition-colors cursor-pointer" onclick="document.getElementById('agree_all').click()">
                        <label class="checkbox-wrapper flex items-start cursor-pointer group select-none pointer-events-none">
                            <input type="checkbox" name="agree_all" id="agree_all" class="hidden" required>
                            <div class="w-5 h-5 border-2 border-gray-300 rounded flex items-center justify-center mr-3 mt-0.5 transition-colors bg-white shrink-0">
                                <svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                            <div>
                                <span class="text-sm font-bold text-gray-800">
                                    개인정보 수집 및 이용 동의 <span class="text-pink-400 text-xs font-normal ml-0.5">(필수)</span>
                                </span>
                                <p class="text-xs text-gray-500 mt-1 break-keep leading-snug">
                                    상품 안내를 위해 연락처 정보를 수집합니다. <span class="text-gray-400">(회원 가입)</span>
                                </p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- 버튼 그룹 -->
                <div class="flex flex-col gap-3">
                    <!-- 카카오 (CTA 변경: 확인하기 -> 상품 보러가기) -->
                    <button type="button" id="btnKakao" onclick="processKakaoLogin()"
                        class="w-full py-4 rounded-lg font-bold text-[15px] btn-kakao flex items-center justify-center gap-2 shadow-sm hover:opacity-90 transition">
                        <i class="fas fa-comment text-lg"></i>
                        카카오로 1초 만에 상품 보기
                    </button>

                    <!-- 일반 전환 -->
                    <button type="button" id="btnGeneral" onclick="showGeneralInput()"
                        class="w-full py-3 rounded-lg font-medium text-sm text-gray-500 hover:text-gray-800 hover:bg-gray-100 transition underline decoration-1 underline-offset-4">
                        다른 방법으로 보기
                    </button>
                    
                    <!-- 일반 다음 버튼 -->
                    <button type="button" id="btnStep1Next" onclick="processGeneralStep1()"
                        class="w-full py-4 btn-brand rounded-lg font-bold text-[15px] shadow-md transition hidden">
                        상품 보러가기
                    </button>
                </div>
            </div>

            <!-- ================= STEP 2: 정보 매칭 (Matching) ================= -->
            <div id="step2_section" class="hidden">
                
                <div class="mb-8 text-center">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">사업자 정보 확인</h2>
                    <p class="text-sm font-medium text-gray-500 break-keep">
                        정확한 매칭을 위해 가게 정보를 입력해주세요.
                    </p>
                </div>

                <!-- 상호명 (엔터키 처리 추가) -->
                <div class="mb-5">
                    <label class="block text-sm font-bold text-gray-700 mb-1.5">
                        상호명 <span class="text-pink-400 text-xs font-normal ml-0.5">(필수)</span>
                    </label>
                    <input type="text" name="mb_company" id="mb_company" 
                        class="w-full px-4 py-3.5 border border-gray-200 rounded-lg input-box-style input-focus transition-colors text-sm placeholder-required"
                        placeholder="상호명을 입력하세요" onkeydown="handleCompanyKeydown(event)">
                </div>

                <!-- 주소 -->
                <div class="mb-8">
                    <label class="block text-sm font-bold text-gray-700 mb-1.5">
                        가게 주소 (배송지) <span class="text-pink-400 text-xs font-normal ml-0.5">(필수)</span>
                    </label>
                    
                    <!-- 기본 주소 + 검색 버튼 -->
                    <div class="flex gap-2 mb-2">
                        <input type="hidden" name="mb_zip" id="mb_zip">
                        <input type="hidden" name="mb_addr3" id="mb_addr3">
                        
                        <input type="text" name="mb_addr1" id="mb_addr1" 
                            class="flex-1 px-4 py-3.5 border border-gray-200 rounded-lg input-box-style text-gray-800 text-sm input-focus cursor-pointer placeholder-required"
                            placeholder="우측 버튼으로 검색하세요" readonly onclick="openDaumPostcode()">
                        <button type="button" onclick="openDaumPostcode()" 
                            class="px-5 py-3.5 btn-brand text-sm font-bold rounded-lg transition whitespace-nowrap shadow-sm">
                            검색
                        </button>
                    </div>

                    <!-- 상세 주소 -->
                    <input type="text" name="mb_addr2" id="mb_addr2" 
                        class="w-full px-4 py-3.5 border border-gray-200 rounded-lg input-box-style input-focus text-sm transition-colors"
                        placeholder="상세주소를 입력해주세요 (예: 1층)" >

                    <p class="text-xs text-gray-500 ml-1 mt-1.5">
                        <i class="fas fa-info-circle mr-1 text-[#14682A]"></i>주소 정보를 기반으로 상품이 매칭됩니다.
                    </p>
                </div>

                <!-- 최종 버튼 -->
                <button type="button" onclick="submitFinalForm()"
                    class="w-full py-4 btn-brand rounded-lg font-bold text-[15px] shadow-md transition hover:bg-[#0f5220]">
                    완료
                </button>
            </div>

        </form>
    </div>

    <!-- 성공 팝업 -->
    <div id="toast-overlay">
        <div class="bg-white rounded-xl p-6 w-[320px] text-center shadow-2xl transform scale-100 transition-transform">
            <div class="w-12 h-12 bg-green-50 text-[#14682A] rounded-full flex items-center justify-center mx-auto mb-4 text-xl">
                <i class="fas fa-check"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">매칭이 완료되었습니다!</h3>
            <p class="text-sm text-gray-600 mb-4">
                사장님 지역의 특가 상품을 불러옵니다.<br>
                <span class="text-[#14682A] font-bold">오더즈 메인으로 이동합니다.</span>
            </p>
            <div class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                <div class="bg-[#14682A] h-full w-0 transition-all duration-[1500ms] ease-out" id="progress-bar"></div>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const ytCode = urlParams.get('yt_code') || '';
            document.getElementById('yt_code').value = ytCode;
            document.getElementById('next_url').value = urlParams.get('next') || 'https://orderz.kr/';
            
            // [정책] 유통사 코드 유무에 따라 회원 소속 구분
            const source = ytCode ? 'DISTRIBUTOR' : 'HQ';
            document.getElementById('join_source').value = source;
            console.log(`[Init] Mode: ${source}, Code: ${ytCode}`);
        });

        // 1. 카카오 가입 처리
        function processKakaoLogin() {
            document.getElementById('join_type').value = 'kakao';
            // 실무: Kakao.Auth.authorize() 호출
            goToStep2();
        }

        // 2. 일반 가입 전환
        function showGeneralInput() {
            document.getElementById('generalInputArea').classList.remove('hidden');
            document.getElementById('btnKakao').classList.add('hidden');
            document.getElementById('btnGeneral').classList.add('hidden');
            document.getElementById('btnStep1Next').classList.remove('hidden');
            document.getElementById('mb_hp').focus();
            document.getElementById('join_type').value = 'general';
        }

        // 3. 일반 가입 1단계 확인
        function processGeneralStep1() {
            if(!checkAgreement()) return;
            const hp = document.getElementById('mb_hp');
            if(!hp.value || hp.value.length < 10) {
                alert("휴대폰 번호를 올바르게 입력해주세요.");
                hp.focus();
                return;
            }
            goToStep2();
        }

        function checkAgreement() {
            const agree = document.getElementById('agree_all');
            if(!agree.checked) {
                alert("개인정보 수집 및 이용에 동의해주세요.");
                return false;
            }
            return true;
        }

        function goToStep2() {
            document.getElementById('step1_section').classList.add('hidden');
            const step2 = document.getElementById('step2_section');
            step2.classList.remove('hidden');
            step2.classList.add('fade-in');
            document.getElementById('dot2').classList.add('active');
            
            // 모바일 키보드 가림 방지
            setTimeout(() => { 
                const companyInput = document.getElementById('mb_company');
                companyInput.focus(); 
                companyInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

        // 엔터키 입력 시 다음 단계 유도 (주소창)
        function handleCompanyKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const addrInput = document.getElementById('mb_addr1');
                addrInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // openDaumPostcode(); // 팝업 자동 띄우기는 제거함 (사용자 선택 존중)
            }
        }

        // 주소 검색 및 제출 로직
        function openDaumPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    var addr = ''; var extraAddr = '';
                    if (data.userSelectedType === 'R') { addr = data.roadAddress; } else { addr = data.jibunAddress; }
                    if(data.userSelectedType === 'J' && (!addr || addr === '')){ addr = data.autoJibunAddress; }
                    if(data.userSelectedType === 'R'){
                        if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){ extraAddr += data.bname; }
                        if(data.buildingName !== '' && data.apartment === 'Y'){ extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName); }
                        if(extraAddr !== ''){ extraAddr = ' (' + extraAddr + ')'; }
                    }
                    if(document.getElementById('mb_zip')) { document.getElementById('mb_zip').value = data.zonecode; }
                    
                    const addrInput = document.getElementById('mb_addr1');
                    if(addrInput) {
                        addrInput.value = addr;
                        addrInput.classList.add('text-gray-900', 'font-medium');
                    }
                    if(document.getElementById('mb_addr3')) { document.getElementById('mb_addr3').value = extraAddr; }
                    if(document.getElementById('mb_addr2')) { document.getElementById('mb_addr2').focus(); }
                }
            }).open();
        }

        function submitFinalForm() {
            const company = document.getElementById('mb_company');
            const addr1 = document.getElementById('mb_addr1');
            if(!company.value) { alert("상호명을 입력해주세요."); company.focus(); return; }
            if(!addr1.value) { alert("주소를 검색해주세요."); openDaumPostcode(); return; }
            showSuccessAndRedirect();
        }

        function showSuccessAndRedirect() {
            const nextUrl = document.getElementById('next_url').value;
            const toast = document.getElementById('toast-overlay');
            const bar = document.getElementById('progress-bar');
            
            toast.classList.add('show');
            setTimeout(() => { bar.style.width = "100%"; }, 100);
            setTimeout(() => { window.location.href = nextUrl; }, 1600);
        }

        function autoHyphen(target) {
            target.value = target.value.replace(/[^0-9]/g, '').replace(/^(\d{0,3})(\d{0,4})(\d{0,4})$/g, "$1-$2-$3").replace(/(\-{1,2})$/g, "");
            
            if (target.value.length === 13) {
                target.blur();
                const agreeBox = document.querySelector('#generalInputArea .border');
                if (agreeBox) {
                    agreeBox.scrollIntoView({behavior: 'smooth', block: 'center'});
                    agreeBox.classList.remove('border-gray-200');
                    agreeBox.classList.add('border-[#14682A]', 'ring-1', 'ring-[#14682A]', 'bg-green-50');
                    setTimeout(() => { agreeBox.classList.remove('bg-green-50'); }, 1000);
                }
            }
        }
    </script>
</body>
</html>
